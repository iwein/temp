---
template: template.html
---

<div class="alert-container">
  <div id="invalid" class="alert alert-warning not-visible">Invalid token</div>
  <div id="error" class="alert alert-danger not-visible">You must type the same password on both fields.</div>
  <div id="success" class="alert alert-success not-visible">Password reset successfuly, you can now log in.</div>
</div>

<div class="banner">
  <div class="banner-inner banner-inner-small">
    <form class="banner-login">
      <h3>Reset password</h3>

      <div class="form-group required">
        <label>Password</label>
        <input type="password" class="form-control" name="password" required>
      </div>

      <div class="form-group required">
        <label>Confirm password</label>
        <input type="password" class="form-control" name="confirm" required>
      </div>

      <div class="form-group">
        <button type="submit" class="btn btn-primary" disabled>Reset password</button>
      </div>
    </form>
  </div>
</div>

<script type="text/javascript">
  (function() {
    'use strict';
    var token = getQueryParam('token');
    var url = app.api_url + 'v1/resetpassword/' + token;
    var $form = document.querySelector('form');
    var $password = document.querySelector('[name=password]');
    var $confirm = document.querySelector('[name=confirm]');
    var $button = document.querySelector('button[type=submit]');
    var $error =  document.querySelector('#error');
    var $success = document.querySelector('#success');
    var $invalid = document.querySelector('#invalid');


    $password.addEventListener('keyup', checkEquality);
    $confirm.addEventListener('keyup', checkEquality);

    $form.addEventListener('submit', function(event) {
      event.preventDefault();
      request('POST', url, { pwd: $password.value }, function(request) {
        var response = JSON.parse(request.responseText);
        display(response.success ? $success : $error);
      });
    }, true);

    request('GET', url, function(request) {
      try {
        var response = JSON.parse(request.responseText);
        if (!response.success)
          tokenInvalid();
      } catch(err) {
        tokenInvalid();
      }
    });


    function tokenInvalid() {
      $password.disabled = true;
      $confirm.disabled = true;
      show($invalid);
    }

    function getQueryParam(key) {
      var query = {};
      document.location.search.substr(1).split(';').map(function(param) {
        var compound = param.split('=');
        query[compound[0]] = compound[1];
      });
      return query[key] || null;
    }

    function checkEquality() {
      var password = $password.value;
      var confirm = $confirm.value;

      if (!password || !confirm) {
        $button.disabled = true;
        hide($error);
      } else if (password === confirm) {
        $button.disabled = false;
        hide($error);
      } else {
        $button.disabled = true;
        show($error);
      }
    }

    function display(element) {
      show(element);
      setTimeout(hide.bind(null, element), 20000);
    }

    function show(element) {
      element.style.display = 'block';
    }

    function hide(element) {
      element.style.display = 'none';
    }

    function request(method, url, data, callback) {
      if (arguments.length === 3) {
        callback = data;
        data = null;
      }

      var xhr = new XMLHttpRequest();
      xhr.open(method, url);
      xhr.withCredentials = true;

      if (method === 'POST' || method === 'PUT') {
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(data));
      } else {
        xhr.send(null);
      }

      xhr.addEventListener('readystatechange', function() {
        if (xhr.readyState === 4)
          callback(xhr);
      });
    }
  });
</script>
